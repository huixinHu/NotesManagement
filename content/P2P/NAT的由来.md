# 1.NAT的由来

## IPV4

IPv4使用32bits整数表达一个地址，地址最大范围就是2^32 约为43亿。以IP创始时期可被联网的设备来看，这样的一个空间已经很大，很难被短时间用完。然而，计算机网络在此后的几十年里迅速壮大，网络终端数量呈爆炸性增长。

为了路由和管理方便，43亿的地址空间被按照不同前缀长度划分为A,B,C,D类地址网络和保留地址。

![](../image/200926crr724j68tledk1p.png)

A类网络地址127段，每段包括主机地址约1678万个。B类网络地址16384段，每段包括65536个主机地址。IANA向超大型企业/组织分配A类地址，一次一段。向中型企业分类B类地址，一次一段。这种分配策略使得IP地址浪费很严重，很多被分配出去的地址没有真实被利用，地址消耗很快。因此，要采取措施来减缓IPv4地址的消耗：网络地址转换NAT。

# 2.NAT工作模型和特点

## 2.1概念模型

内部网络IP地址：RFC1918规定了三个保留地址段落：`10.0.0.0-10.255.255.255`、`172.16.0.0-172.31.255.255`、`192.168.0.0-192.168.255.255`。这三个范围分别处于A、B、C类的地址段，不向特定的用户分配，作为私有地址保留。这些地址可以在任何组织或企业内部使用，和其他Internet地址的区别就是，仅能在内部使用，不能作为全球路由地址。这就是说，出了组织的管理范围这些地址就不再有意义，无论是作为源地址，还是目的地址。对于一个封闭的组织，如果其网络**不连接到Internet**，就可以使用这些地址而不用向IANA提出申请，而在内部的路由管理和报文传递方式与其他网络没有差异。

NAT通常部署在一个组织的网络出口位置，通过将内部网络IP地址替换为出口的IP地址提供公网可达性和上层协议的连接能力。

如果一个内部使用私有地址的网络有访问Internet的需求，就要在组织的出口位置部署NAT网关，在报文离开私网进入Internet时，将源IP替换为公网地址。一个对外的访问请求在到达目标以后，表现为由本组织**出口设备**发起，因此被请求的服务端可将响应由Internet发回出口网关。出口网关再将目的地址替换为私网的源主机地址，发回内部。这样一次由私网主机向公网服务端的请求和响应就在通信两端均无感知的情况下完成了。依据这种模型，数量庞大的内网主机就不再需要公有IP地址了。

#### NAT处理报文的关键特点

1. 网络分为私网和公网两部分，NAT网关设置在私网到公网的路由出口位置，双向流量必须都要经过NAT网关。
2. 网络访问**只能由私网侧发起**，公网无法**主动访问**私网主机。
3. NAT网关在两个访问方向上完成两次地址的转换或翻译，出方向做源信息替换，入方向做目的信息替换； 
4. NAT网关的存在对通信双方是保持透明的； 
5. NAT网关为了实现双向翻译的功能，需要维护一张关联表，把会话的信息保存下来。

第二个特点打破了IP协议架构中所有节点在通讯中的对等地位，这是NAT最大的弊端，为对等通讯带来了诸多问题，当然相应的克服手段也应运而生。第四点是NAT致力于达到的目标，但在很多情况下，NAT并没有做到，因为除了IP首部，上层通信协议经常在内部携带IP地址信息。

## 2.2一对一NAT

一个内部主机唯一占用一个公网IP，这种方式被称为一对一模型。此种方式下，转换上层协议就是不必要的，因为一个公网IP就能唯一对应一个内部主机。这种方式对节约公网IP没有太大意义，主要是为了实现一些特殊的组网需求。比如用户希望隐藏内部主机的真实IP，或者实现两个IP地址重叠网络的通信。

## 2.3一对多NAT

一个组织网络，在出口位置部署NAT网关，所有对公网的访问表现为一台主机。这就是所谓的一对多模型。

这种方式下，出口设备只占用一个由Internet服务提供商分配的公网IP地址。面对私网内部数量庞大的主机，如果NAT只进行IP地址的简单替换，就会产生一个问题：当有多个内部主机去访问同一个服务器时，从返回的信息不足以区分响应应该转发到哪个内部主机。此时，**需要NAT设备根据传输层信息或其他上层协议去区分不同的会话**，并且可能要对上层协议的标识进行转换，比如**TCP或UDP端口号**。这样NAT网关就可以将不同的内部连接访问映射到同一公网IP的不同传输层端口，通过这种方式实现公网IP的复用和解复用。这种方式也被称为**端口转换PAT**、NAPT或IP伪装，但更多时候直接被称为NAT，因为它是最典型的一种应用模式。

### 按照NAT端口映射方式分类

主机端口对 —— 将IP和端口标记为(nAddr:nPort)

#### 全锥形NAT

一旦内部主机端口对(iAddr:iPort)被NAT网关映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；**任何一个外部主机**发送到(eAddr:ePort)的报文将会被转换后发到(iAddr:iPort)。

#### 限制锥形NAT

一旦内部主机端口对(iAddr:iPort)被映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；只有 (iAddr:iPort)向**特定的外部主机**hAddr**发送过**数据，主机hAddr从**任意端口**发送到(eAddr:ePort)的报文将会被转发到(iAddr:iPort)。

#### 端口限制锥形NAT

一旦内部主机端口对(iAddr:iPort)被映射到(eAddr:ePort)，所有后续的(iAddr:iPort)报文都会被转换为(eAddr:ePort)；只有(iAddr:iPort)向**特定的外部主机端口对**(hAddr:hPort)发送过数据，由 (hAddr:hPort)发送到(eAddr:ePort)的报文将会被转发到(iAddr:iPort)。

#### 对称型NAT

NAT网关会把内部主机“地址端口对”和外部主机“地址端口对”完全相同的报文看作一个连接，在网关上创建一个公网“地址端口对”映射进行转换，只有收到报文的外部主机从对应的端口对发送回应的报文，才能被转换。即使内部主机使用之前用过的地址端口对去连接不同外部主机(或端口)时，NAT网关也会建立新的映射关系。

# 3.NAT的限制

## 3.1端到端服务

根据IP协议，不同的IP地址之间没有差异。在理论上，具有IP地址的每个站点在协议层面有相同的**获取服务**和**提供服务**的能力，也即我们熟悉的服务端和客户端。服务器和客户端实际是在应用协议层上的角色区分，而在网络层和传输层没有差异。一个具有IP地址的主机既可以是客户机，也可以是服务器，大部分情况下，既是客户机，也是服务器。

在P2P的应用中，一个用户的主机既为下载的客户，同时也向其他客户提供数据，是一种C/S混合的模型。上层应用之所以能这样设计，是因为IP协议栈定义了这样的能力。然而，NAT最大的弊端正在于破坏了IP端到端通信的能力。

## 3.2NAT的弊端









